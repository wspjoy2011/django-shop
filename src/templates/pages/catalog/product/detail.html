{% extends 'layout/base.html' %}
{% load static %}
{% load rating_tags %}
{% load product_price %}
{% load favorite_tags %}

{% block title %}{{ product.product_display_name }} — Django Shop{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/pages/catalog-product-detail.css' %}">
  <link rel="stylesheet" href="{% static 'css/components/category-navigation.css' %}">
  <link rel="stylesheet" href="{% static 'css/components/product-cta-buttons.css' %}">
  <link rel="stylesheet" href="{% static 'css/components/likes-dislikes.css' %}">
  <link rel="stylesheet" href="{% static 'css/components/ratings.css' %}">
  <link rel="stylesheet" href="{% static 'css/components/product-price.css' %}">
  <link rel="stylesheet" href="{% static 'css/components/favorite-button.css' %}">
{% endblock %}

{% block extra_js %}
  <script type="module" src="{% static 'js/components/likes-dislike.js' %}" defer></script>
  <script type="module" src="{% static 'js/components/rating-stars.js' %}" defer></script>
  <script type="module" src="{% static 'js/components/favorite-button.js' %}" defer></script>
{% endblock %}

{% block content %}
  <div class="container py-4 product-detail">

    <!-- Admin Floating Toolbar -->
    {% if request.user.is_authenticated and request.user.is_staff %}
      <div class="admin-toolbar position-fixed" style="top: 20px; right: 20px; z-index: 1000;">
        <div class="btn-group-vertical shadow">
          <a href="{% url 'catalog:product_update' slug=product.slug %}"
             class="btn btn-warning btn-sm"
             title="Edit Product">
            <i class="fas fa-pen-to-square"></i>
          </a>
          <a href="{% url 'catalog:product_delete' slug=product.slug %}"
             class="btn btn-danger btn-sm"
             title="Delete Product">
            <i class="fas fa-trash-alt"></i>
          </a>
        </div>
      </div>
    {% endif %}

    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb small">
        <li class="breadcrumb-item"><a href="{% url 'catalog:home' %}">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'catalog:product_list' %}">Catalog</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ product.product_display_name }}</li>
      </ol>
    </nav>

    <!-- Category Navigation Router -->
    <div class="category-router mb-4">
      <div class="d-flex align-items-center flex-wrap gap-2">
        <span class="text-muted small me-2">
          <i class="fas fa-sitemap me-1"></i>Category:
        </span>

        <!-- Master Category -->
        <a href="{{ product.article_type.sub_category.master_category.get_absolute_url }}"
           class="category-link category-master">
          <i class="fas fa-layer-group me-1"></i>
          {{ product.article_type.sub_category.master_category.name }}
        </a>

        <i class="fas fa-chevron-right text-muted"></i>

        <!-- Sub Category -->
        <a href="{{ product.article_type.sub_category.get_absolute_url }}"
           class="category-link category-sub">
          <i class="fas fa-folder me-1"></i>
          {{ product.article_type.sub_category.name }}
        </a>

        <i class="fas fa-chevron-right text-muted"></i>

        <!-- Article Type -->
        <a href="{{ product.article_type.get_absolute_url }}"
           class="category-link category-article">
          <i class="fas fa-tag me-1"></i>
          {{ product.article_type.name }}
        </a>
      </div>
    </div>

    <!-- Header with Rating -->
    <div class="detail-header p-4 p-lg-5 mb-4">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
        <div class="flex-grow-1">
          <h1 class="h3 fw-bold mb-2">
            {{ product.product_display_name }}
          </h1>
          <div class="text-muted small">
            Product ID: {{ product.product_id }}{% if product.year %} • Year: {{ product.year }}{% endif %}
          </div>
        </div>
        <!-- Rating in header -->
        {% with rating_stats=product.get_rating_stats %}
          <div class="mt-3 mt-md-0 ms-md-4">
            {% rating_stars rating_stats.avg_rating rating_stats.ratings_count product size='large' %}
          </div>
        {% endwith %}
      </div>
    </div>

    <div class="row g-4 align-items-start">
      <!-- Image -->
      <div class="col-12 col-lg-6">
        <div class="detail-image shadow-sm">
          {% if product.image_url %}
            <img class="img-fluid" src="{{ product.image_url }}" alt="{{ product.product_display_name }}">
          {% else %}
            <div class="no-image">No image available</div>
          {% endif %}
        </div>
      </div>

      <!-- Info -->
      <div class="col-12 col-lg-6">
        <div class="detail-card p-4 p-lg-5 shadow-sm">

          <!-- Badges -->
          <div class="d-flex flex-wrap gap-2 mb-3">
            {% if product.gender %}
              <span class="badge badge-soft">{{ product.gender }}</span>
            {% endif %}
            {% if product.base_colour %}
              <span class="badge badge-soft-secondary">
              <i class="fas fa-palette me-1"></i>{{ product.base_colour.name }}
            </span>
            {% endif %}
            {% if product.season %}
              <span class="badge badge-soft-warning">
              <i class="fas fa-sun me-1"></i>{{ product.season.name }}
            </span>
            {% endif %}
            {% if product.usage_type %}
              <span class="badge badge-soft-success">
              <i class="fas fa-person-running me-1"></i>{{ product.usage_type.name }}
            </span>
            {% endif %}
          </div>

          <!-- Price -->
          <div class="mb-4">
            <h6 class="text-muted mb-2">Price:</h6>
            {% product_price product size='xl' %}
          </div>

          <div class="soft-sep"></div>

          <!-- Meta list -->
          <ul class="list-unstyled small mb-4 detail-meta">
            <li class="mb-2">
              <span class="text-muted me-2"><i class="fas fa-venus-mars me-1"></i>Gender:</span>
              <strong>{{ product.gender }}</strong>
            </li>
            {% if product.article_type %}
              <li class="mb-2">
                <span class="text-muted me-2"><i class="fas fa-shirt me-1"></i>Article type:</span>
                <strong>{{ product.article_type.name }}</strong>
              </li>
            {% endif %}
            {% if product.base_colour %}
              <li class="mb-2">
                <span class="text-muted me-2"><i class="fas fa-droplet me-1"></i>Base colour:</span>
                <strong>{{ product.base_colour.name }}</strong>
              </li>
            {% endif %}
            {% if product.season %}
              <li class="mb-2">
                <span class="text-muted me-2"><i class="fas fa-cloud-sun me-1"></i>Season:</span>
                <strong>{{ product.season.name }}</strong>
              </li>
            {% endif %}
            {% if product.usage_type %}
              <li class="mb-2">
                <span class="text-muted me-2"><i class="fas fa-bullseye me-1"></i>Usage:</span>
                <strong>{{ product.usage_type.name }}</strong>
              </li>
            {% endif %}
            {% if product.year %}
              <li class="mb-2">
                <span class="text-muted me-2"><i class="fas fa-calendar-alt me-1"></i>Year:</span>
                <strong>{{ product.year }}</strong>
              </li>
            {% endif %}
          </ul>

          <!-- Likes/Dislikes Section -->
          <div class="mb-4">
            <div class="d-flex align-items-center justify-content-between">
              <h6 class="text-muted mb-0">Community feedback:</h6>
              {% likes_dislikes product.get_likes_count product.get_dislikes_count product size='large' %}
            </div>
          </div>

          <div class="soft-sep"></div>

          <!-- CTA -->
          <div class="product-cta">
            <a href="#" class="btn btn-primary btn-lg">
              <i class="fas fa-cart-plus"></i>Add to cart
            </a>

            <div>
              {% favorite_button product size='large' show_count=True %}
            </div>

            <a href="{% url 'catalog:product_list' %}" class="btn btn-link">
              <i class="fas fa-arrow-left"></i>Back to catalog
            </a>
          </div>

        </div>
      </div>
    </div>

    <!-- More section with Rating Summary -->
    <div class="row mt-5">
      <div class="col-12">
        <div class="more-box p-4 p-lg-5">
          <div class="row">
            <div class="col-12 col-md-8">
              <h2 class="h5 fw-bold mb-3">About this item</h2>
              <p class="text-muted mb-0">
                Classic piece from our dataset-driven catalog. Colours and styles tailored for different seasons and
                usage
                types.
              </p>
            </div>
            <div class="col-12 col-md-4">
              <!-- Rating and Likes/Dislikes Summary -->
              {% with rating_stats=product.get_rating_stats %}
                <div class="mt-4 mt-md-0">
                  <h6 class="fw-bold mb-3">User Reviews & Ratings</h6>
                  <div class="d-flex flex-column align-items-start gap-3">
                    <div>
                      {% rating_stars rating_stats.avg_rating rating_stats.ratings_count product %}
                    </div>
                    <div>
                      {% likes_dislikes product.get_likes_count product.get_dislikes_count product %}
                    </div>
                  </div>
                </div>
              {% endwith %}
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
{% endblock %}
